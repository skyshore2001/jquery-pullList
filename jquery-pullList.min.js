
function jquery_pullList($){var m_version='1.0';var m_exposed={version:function(jo){return m_version;}};var m_defaults={prefix:"mui",threshold:180,autoLoadMore:true,TRIGGER_AUTOLOAD:30,};$.event.special["autoload"]={setup:function(){var busy_=false;var jo=$(this);jo.on("scroll.autoload",function(ev){if(getScrollToBottom(jo[0])<m_defaults.TRIGGER_AUTOLOAD){if(!busy_){busy_=true;ev.type='autoload';jo.trigger(ev);scrollToBottom(jo[0]);}}
else{busy_=false;}});},teardown:function(){$(this).off("scroll.autoload");}};$.fn.extend({pullList:function(opt){var args=arguments;if(typeof(opt)=="string")
{var fname=opt;if(!m_exposed[fname])
$.error("*** unknown call: "+fname);args[0]=this;return m_exposed[fname].apply(args[0],args);}
return this.each(function(){initPullList(this,opt);});}});$.fn.pullList.defaults=m_defaults;function getScrollToBottom(o)
{return o.scrollHeight-$(o).outerHeight(true)-o.scrollTop;}
function canScroll(o)
{return o.scrollHeight>$(o).outerHeight(true);}
function isScrollBottom(o)
{return getScrollToBottom(o)<=1;}
function scrollToBottom(o)
{o.scrollTop=o.scrollHeight-o.clientHeight;}
window.initPullList=initPullList;function initPullList(container,opt)
{var opt_=$.extend({onHint:onHint},m_defaults,opt);var cont_=container;var scrollContainer_=null;var touchev_=null;var mouseMoved_=false;if("ontouchstart"in window){cont_.addEventListener("touchstart",touchStart);cont_.addEventListener("touchmove",touchMove);cont_.addEventListener("touchend",touchEnd);cont_.addEventListener("touchcancel",touchCancel);}
else{cont_.addEventListener("mousedown",mouseDown);}
if($(cont_).css("overflowY")=="visible"){cont_.style.overflowY="auto";}
function getPos(ev)
{var t=ev;if(ev.changedTouches){t=ev.changedTouches[0];}
return[t.pageX,t.pageY];}
var jo_;function onHint(ac,dy,threshold)
{var msg=null;if(jo_==null){jo_=$("<div class='mui-pullPrompt'></div>");}
var uptoThreshold=dy>=threshold;if(ac=="U"){msg=uptoThreshold?"<b>松开加载~~~</b>":"即将加载...";}
else if(ac=="D"){msg=uptoThreshold?"<b>松开刷新~~~</b>":"即将刷新...";}
if(opt_.onHintText){var rv=opt_.onHintText(ac,uptoThreshold);if(rv!=null)
msg=rv;}
var height=Math.min(dy,100,2.0*Math.pow(dy,0.7));if(msg==null){jo_.height(0).remove();return;}
jo_.html(msg);jo_.height(height).css("lineHeight",height+"px");if(ac=="D"){var c=cont_.getElementsByClassName("mui-pullHint")[0];if(c)
jo_.appendTo(c);else
jo_.prependTo(cont_);}
else if(ac=="U"){jo_.appendTo(cont_);}}
function updateHint(ac,dy)
{if(ac==null||dy==0||(opt_.autoLoadMore&&ac=='U')){ac=null;}
else{dy=Math.abs(dy);}
opt_.onHint.call(this,ac,dy,opt_.threshold);}
function onAutoload(ev)
{if($(container).is(":visible")){console.log("load more");opt_.onLoadItem.call(cont_,false);}}
function checkScrollContainer(ev)
{if(scrollContainer_&&!canScroll(scrollContainer_)){$(scrollContainer_).off("autoload",onAutoload);scrollContainer_=null;}
if(scrollContainer_==null){var o=cont_;while(o!=null){if(canScroll(o)){scrollContainer_=o;break;}
o=o.parentElement;}
if(scrollContainer_&&opt_.autoLoadMore){$(scrollContainer_).on("autoload",onAutoload);}}}
function touchStart(ev)
{if(opt_.onPull&&opt_.onPull(ev)===false){ev.cancelPull_=true;return;}
checkScrollContainer();var p=getPos(ev);touchev_={ac:null,x0:p[0],y0:p[1],dx:0,dy:0,};}
function mouseDown(ev)
{mouseMoved_=false;touchStart(ev);if(ev.cancelPull_===true)
return;window.addEventListener("mousemove",mouseMove,true);window.addEventListener("mouseup",mouseUp,true);window.addEventListener("click",click,true);}
function click(ev)
{window.removeEventListener("click",click,true);if(mouseMoved_)
{ev.stopPropagation();ev.preventDefault();}}
function mouseMove(ev)
{touchMove(ev);if(touchev_==null)
return;if(touchev_.dx!=0||touchev_.dy!=0)
mouseMoved_=true;ev.stopPropagation();ev.preventDefault();}
function mouseUp(ev)
{touchEnd(ev);window.removeEventListener("mousemove",mouseMove,true);window.removeEventListener("mouseup",mouseUp,true);ev.stopPropagation();ev.preventDefault();}
function touchMove(ev)
{if(touchev_==null)
return;var p=getPos(ev);touchev_.dx=p[0]-touchev_.x0;touchev_.dy=p[1]-touchev_.y0;var dy=touchev_.dy;if(Math.abs(touchev_.dx)>Math.abs(touchev_.dy)){touchCancel();return;}
if(dy<0&&scrollContainer_&&(opt_.autoLoadMore||!isScrollBottom(scrollContainer_))){touchCancel();return;}
if(dy>0&&scrollContainer_&&scrollContainer_.scrollTop>0){touchCancel();return;}
if(dy>0&&cont_.scrollTop<=0){touchev_.ac="D";}
else if(dy<0&&isScrollBottom(cont_)){touchev_.ac="U";}
updateHint(touchev_.ac,dy);if(touchev_.ac=="U"&&scrollContainer_){scrollToBottom(scrollContainer_);}
ev.preventDefault();}
function touchCancel(ev)
{touchev_=null;updateHint(null,0);}
function touchEnd(ev)
{updateHint(null,0);if(touchev_==null||touchev_.ac==null||(Math.abs(touchev_.dy)<opt_.threshold&&!(touchev_.ac=="U"&&opt_.autoLoadMore)))
{touchev_=null;return;}
console.log(touchev_);doAction(touchev_.ac);touchev_=null;function doAction(ac)
{if(ac=="D"){console.log("refresh");opt_.onLoadItem.call(cont_,true);}
else if(ac=="U"){console.log("load more");opt_.onLoadItem.call(cont_,false);}}}}}
jquery_pullList(window.jQuery);